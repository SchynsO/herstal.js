"use strict";function _classCallCheck(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,o){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?t:o}function _inherits(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);t.prototype=Object.create(o&&o.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(t,o):t.__proto__=o)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(){function t(o,e,i){i=i||{},this.name=o,this.character=e,this.damage=i.damage||0,i.maxAmmo>0&&(this.ammo=i.ammo,this.maxAmmo=i.maxAmmo),this.firerate=i.firerate>0?i.firerate:60,this.acquired=!i.notAcquired;var r=i.team||"none",s=this.character.player.current?"self_":"",n=t.FILTERS[s+r]||t.FILTERS.none,a=i.filterGroup,h=i.filterMask;this.filterGroup=null!=a?a:n.group,this.filterMask=null!=h?h:n.mask}function o(e,i,r,n,a){a=a||{},this.world=null,this.player=e,this.inputs=null,this.weapons=n||[new t("none",this)],this.currentWeapon=0,this.characterModel=null,this.health=a.health||100,this.maxHealth=a.maxHealth||100,this.armor=a.armor,this.maxArmor=a.maxArmor,this.isDead=!1,this.moveSpeed=a.moveSpeed||20,this.crounchSpeed=a.crounchSpeed||10,this.jumpForce=a.jumpForce||30;var h=a.headWidth,l=a.headHeight,p=a.fullWidth,c=a.fullHeight,d=a.bodyWitdh,u=a.bodyHeight,y=a.fullCrounched,f=a.bodyCrounched;h=h>0?h:.6,l=l>0?l:.4,c>0&&(c-=l),hc>0&&(y-=l),d=d||p,u=u||c,f=f||y,d=d>0?d:.8,u=u>0?u:1.4,f=f>0?f:.6,this.headWidth=h,this.headHeight=l,this.bodyWidth=d,this.bodyHeight=u,this.bodyCrounched=f,this.vertices=[{x:0,z:0},{x:d,z:d},{x:d,z:-d},{x:-d,z:d},{x:-d,z:-d}],i=i||{x:0,y:0,z:0},i.y+=this.bodyHeight,this.orientation={x:r||0,y:0},this.isGounded=!1,this.isCrounched=!1,this.jumpTimer=0,this.platform=null;var m={x:0,z:0,y:.5*l},b={x:0,z:0,y:-.5*u},v=new s.Box({x:h,y:l,z:h}),x=new s.Box({x:d,y:u,z:d}),g=a.team||"none",w=this.player.current?"self_":"",E=o.FILTERS[w+g]||o.FILTERS.none,C=a.filterGroup,_=a.filterMask;C=null!=C?C:E.group,_=null!=_?_:E.mask,this.body=new s.Body({position:i,mass:10,material:o.MATERIAL,fixedRotation:!0,collisionFilterGroup:C,collisionFilterMask:_}),this.body.addShape(x,b),this.body.addShape(v,m),this.body.character=this,a.noHead||(v.isHead=!0)}function e(t,o,e){e=e||{},this.id=t,this.name=o,this.team="none",this.character=null,this.current=null,this.colors=e.colors,this.model=e.model,this.weaponAutoSwitch=e.weaponAutoSwitch}function i(){this.step=1/r.__FPS,this.cannonWorld=new s.World,this.cannonWorld.gravity.set(0,-100,0),this.cannonWorld.defaultContactMaterial.friction=.1,this.worldRender=null,this.characterMaterial=new s.Material("character"),this.cannonWorld.addContactMaterial(new s.ContactMaterial(o.MATERIAL,WORLD.defaultMaterial,{friction:0,restitution:0,contactEquationStiffness:1e8,contactEquationRelaxation:3})),this.characters=[]}var r={__FPS:60};window||(window={}),module||(module={}),module.exports=window.HERSTALshared=r;var s=s||require("./cannon.js");if(!s)throw new Error("Herstal.shared needs CANNON.js to work");s.Vec3.prototype.getAngle=function(t){var o=this.clone(),e=t?new s.Vec3(t.x,t.y,t.z):s.Vec3.UNIT_Y;return o.normalize(),e.normalize(),Math.acos(o.dot(e))},Array.prototype.addElement=function(t){var o=this.indexOf(t);return-1==o?(this[this.length]=t,this.length-1):-1},Array.prototype.removeElement=function(t){var o=this.indexOf(t);return o>-1&&this.splice(o,1),o},t.prototype.constructor=r.Weapon=t,t.prototype.fire=function(){},t.prototype.secondary=function(){},t.FILTERS={none:{group:1,mask:1},alpha:{group:1,mask:1},beta:{group:1,mask:1},self_none:{group:1,mask:1},self_alpha:{group:1,mask:1},self_beta:{group:1,mask:1}},r.Character=o,o.prototype.constructor=o,o.prototype.setFromInput=function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&(this.inputs={},this.inputs.orientation=t.o,this.inputs.movement=t.m,this.inputs.jump=!!(1&t.i),this.inputs.crounch=!!(2&t.i),this.inputs.fire1=!!(4&t.i),this.inputs.fire2=!!(8&t.i),this.inputs.use=!!(16&t.i),this.inputs.reload=!!(32&t.i),this.inputs.melee=!!(64&t.i),this.inputs.zoom=!!(128&t.i),this.inputs.weapon=t.w)},o.prototype.setFromData=function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&(this.setLook(t.o),"object"===_typeof(t.p)&&_typeof(t.p.x)===_typeof(t.p.y)===_typeof(t.p.z)==="number"&&this.body.position.copy(t.p),"object"===_typeof(t.v)&&_typeof(t.v.x)===_typeof(t.v.y)===_typeof(t.v.z)==="number"&&this.body.velocity.copy(t.v),null!=t.i&&(this.isGrounded=!!(1&t.i),this.isCrounched=!!(2&t.i)))},o.prototype.getData=function(){return{o:this.orientation,p:{x:this.body.position.x,y:this.body.position.y,z:this.body.position.z},v:{x:this.body.velocity.x,y:this.body.velocity.y,z:this.body.velocity.z},g:this.isGrounded,c:this.isCrounched}},o.prototype.updateAll=function(){var t=this.inputs||{};this.setLook(t.orientation),this.updateGround(),this.updateMove(t.movement,t.jump),this.updateCrounch(t.crounch),this.updatePlatform(),this.setWeapon(t.weapon)},o.prototype.setLook=function(t){if(t){var o=2*Math.PI,e=.5*Math.PI;t.x%=o,t.y%=o,t.y>e?t.y=e:t.y<-e&&(t.y=-e),this.orientation=t}},o.prototype.addRotation=function(t){this.orientation.x+=t,this.orientation.x%=2*Math.PI},o.prototype.updateMove=function(t,e){t=t||{x:0,y:0};var i=t.x*t.x+t.y*t.y;if(i>1){var r=Math.sqrt(i);t.x/=r,t.y/=r}var s=this.orientation.x,n=this.isCrounched?this.crounchedSpeed:this.moveSpeed,a={y:this.body.velocity.y,x:(t.x*Math.cos(s)-t.y*Math.sin(s))*n,z:(-t.x*Math.sin(s)-t.y*Math.cos(s))*n};e&&(this.jumpTimer=o.JUMP_TIMER),this.jumpTimer>0&&--this.jumpTimer,this.isGrounded?this.jumpTimer>0&&(this.jumpTimer=0,a.y=this.jumpForce):(a.x+=this.body.velocity.x,a.z+=this.body.velocity.z,a.x*=.5,a.z*=.5),this.body.velocity=a},o.prototype.updateGround=function(){this.isGrounded=!1;for(var t=0;t<this.dimensions.vertices.length;++t){var e=this.body.vadd(this.dimensions.vertices[t]);e.y-=2*this.body.shapes[0].halfExtents.y;var i=o.checkCollision(this.body.world,e,-.1);if(i.hasHit){var r=i.hitNormalWorld.getAngle(s.Vec3.UNIT_Y);if(r<o.STEEP_SLOPE){if(this.isGrounded=!0,i.body.type===s.Body.KINEMATIC){var n=!1;platform?platform.body!==i.body&&(n=!0):n=!0,n&&(this.platform={body:i.body},this.updatePlatform())}else this.platform=null;return}}}this.platform=null},o.prototype.updatePlatformPosition=function(){var t=this.platform;if(t){var o=t.pointToWorldFrame(t.localPos),e=o.vsub(t.globalPos);this.body.position=this.body.position.vadd(e);var i=t.body.quaternion.mult(t.localRot),r=i.mult(t.globalRot.inverse()),s={};r.toEuler(s),this.addRotation(s.y)}},o.prototype.updatePlatform=function(){this.platform&&(this.platform.globalPos=this.body.position.clone(),this.platform.localPos=this.platform.body.pointToLocalFrame(this.platform.globalPos),this.platform.globalRot=this.body.quaternion.clone(),this.platform.localRot=this.platform.body.quaternion.inverse().mult(this.platform.globalRot))},o.prototype.updateCrounch=function(t){var e=!0;if(t)e=!1,this.isCrounched=!0;else if(this.isCrounched)for(var i=0;i<this.dimensions.vertices.length&&e;++i){var r=this.body.vadd(this.dimensions.vertices[i]);r.y+=this.headHeight;var s=o.checkCollision(this.body.world,r,.1);s.hasHit&&(e=!1)}var n,a=this.body.shapes[0],h=this.body.shapeOffsets[0],l=o.CROUNCH_INCREMENT;e?2*a.halfExtents.y<this.bodyHeight&&(a.halfExtents.y+=2*l,h.y-=l,2*a.halfExtents.y>=this.bodyHeight&&(n=.5*this.bodyHeight,a.halfExtents.y=n,h.y=-n,this.isCrounched=!1)):2*a.halfExtents.y>this.bodyCrounched&&(a.halfExtents.y-=2*l,h.y+=l,2*a.halfExtents.y<this.bodyCrounched&&(n=.5*this.bodyCrounched,a.halfExtents.y=n,h.y=-n))},o.prototype.setWeapon=function(t){if(0!==this.weapons.length||null!=t){var o=this.currentWeapon;if(t>-1&&t<this.weapons.length)null!=this.weapons[t]&&(o=t);else for(var e=-1==t?-1:1,i=0,r=!1;i<this.weapons.length||r;++i)o+=e,o>=this.weapons.length?o=0:0>o&&(o=this.weapons.length-1),null!=this.weapons[o]&&(r=!0);this.currentWeapon=o}},o.prototype.addDamage=function(t){if(this.armor>0){var e=t*o.ARMOR_PROTECTION;t-=e,this.armor-=e,this.armor<0&&(t-=this.armor,this.armor=0)}this.health-=t,this.health<=0&&(this.isDead=!0)},o.prototype.addHealth=function(t){this.health+=t,this.health>this.maxHealth&&this.maxHealth>0&&(this.health=this.maxHealth)},o.prototype.addArmor=function(t){null!=this.armor&&(this.armor+=t,this.armor>this.maxArmor&&null!=this.maxArmor&&(this.armor=this.maxArmor))},o.prototype.killed=function(t){t()},o.checkCollision=function(t,o){var e=arguments.length<=2||void 0===arguments[2]?.1:arguments[2],i=new s.Vec3(o.x,o.y,o.z),r=i.vadd({y:e}),n=new s.Ray(i,r);return n.intersectWorld(t,{mode:Ray.CLOSEST,skipBackfaces:!0,collisionFilterGroup:1,collisionFilterMask:1}),n.result},o.ARMOR_PROTECTION=2/3,o.JUMP_TIMER=10,o.CROUNCH_INCREMENT=.05,o.STEEP_SLOPE=50,o.FILTERS={none:{group:7,mask:7},alpha:{group:11,mask:11},beta:{group:19,mask:19},self_none:{group:1,mask:1},self_alpha:{group:1,mask:1},self_beta:{group:1,mask:1}},e.prototype.constructor=r.Player=e,e.prototype.createCharacter=function(t,e){this.character=new o(this,t,e,{team:this.team})},i.prototype.constructor=r.World=i,i.prototype.update=function(){var t;for(t=0;t<this.characters.length;++t)this.characters[t].updateAll();for(world.step(this.step),t=0;t<this.characters.length;++t)this.characters[t].updatePlatformPosition()},i.prototype.addCharacter=function(t){this.characters.addElement(t),t.world=this,this.cannonWorld.addBody(t.body),this.worldRender&&t.characterModel&&this.worldRender.addCharacterModel(t.characterModel)},i.prototype.removeCharacter=function(t){var o=this.characters.removeElement(t);o>-1&&(t.world=null,this.cannonWorld.removeBody(t.body),this.worldRender&&t.characterModel&&this.worldRender.removeCharacter(t.characterModel))},i.FILTER={group:7,mask:7};var n=function(t){function o(t,e,i,r){return _classCallCheck(this,o),r=r||{},_possibleConstructorReturn(this,Object.getPrototypeOf(o).call(this,t,e,r))}return _inherits(o,t),o}(t);r.Launcher=n}();
//# sourceMappingURL=herstal.shared.min.js.map
