"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(){function t(o,e,i,r){r=r||{},this.world=null,this.player=o,this.inputs=null,this.weapons=[],this.currentWeapon=0,this.characterModel=null,this.health=r.health||t.ATTRIBUTES.defaultHealth,this.maxHealth=r.maxHealth||t.ATTRIBUTES.maxHealth,this.armor=r.armor||t.ATTRIBUTES.defaultArmor,this.maxArmor=r.maxArmor||t.ATTRIBUTES.maxArmor,this.isDead=!1;var n=this.dimensions=r.dimensions||t.DIMENSIONS;n.head_w=n.head_w>0?n.head_w:t.DIMENSIONS.head_w,n.head_h=n.head_h>0?n.head_h:t.DIMENSIONS.head_h,n.body_w=n.body_w>0?n.body_w:t.DIMENSIONS.body_w,n.body_h=n.body_h>0?n.body_h:t.DIMENSIONS.body_h,n.body_c=n.body_c>0?n.body_c:t.DIMENSIONS.body_c,n.vertices?n.vertices.length<0&&(n.vertices=t.DIMENSIONS.vertices):n.vertices=t.DIMENSIONS.vertices,e=e||{x:0,y:0,z:0},e.y+=n.body_h,this.orientation=i||{x:0,y:0},this.isGounded=!1,this.isCrounched=!1,this.jumpTimer=0,this.platform=null;var a={x:0,z:0,y:.5*n.head_h},h={x:0,z:0,y:-.5*n.body_h},d=new s.Box({x:n.head_w,y:n.head_h,z:n.head_w}),l=new s.Box({x:n.body_w,y:n.body_h,z:n.body_w}),c=r.team||"none",p=t.FILTERS[c];p||(p={group:7,mask:7}),this.body=new s.Body({position:e,mass:10,material:t.MATERIAL,fixedRotation:!0,collisionFilterGroup:p.group,collisionFilterMask:p.mask}),this.body.addShape(l,h),this.body.addShape(d,a),this.body.character=this,d.isHead=!0}function o(t,o,e,i){this.id=t,this.name=o,this.colors=e,this.team="none",this.model=i,this.character=null}function e(){this.step=1/i.__FPS,this.cannonWorld=new s.World,this.cannonWorld.gravity.set(0,-100,0),this.cannonWorld.defaultContactMaterial.friction=.1,this.worldRender=null,this.characterMaterial=new s.Material("character"),this.cannonWorld.addContactMaterial(new s.ContactMaterial(t.MATERIAL,WORLD.defaultMaterial,{friction:0,restitution:0,contactEquationStiffness:1e8,contactEquationRelaxation:3})),this.characters=[]}var i={__FPS:60};window||(window={}),module||(module={}),module.exports=window.HERSTALshared=i;var s=s||require("./cannon.js");if(!s)throw new Error("Herstal.shared needs CANNON.js to work");s.Vec3.prototype.getAngle=function(t){var o=this.clone(),e=t?new s.Vec3(t.x,t.y,t.z):s.Vec3.UNIT_Y;return o.normalize(),e.normalize(),Math.acos(o.dot(e))},Array.prototype.addElement=function(t){var o=this.indexOf(t);return-1==o?(this[this.length]=t,this.length-1):-1},Array.prototype.removeElement=function(t){var o=this.indexOf(t);return o>-1&&this.splice(o,1),o},i.Character=t,t.prototype.constructor=t,t.prototype.setFromInput=function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&(this.inputs={},this.inputs.orientation=t.o,this.inputs.movement=t.m,this.inputs.jump=!!(1&t.i),this.inputs.crounch=!!(2&t.i),this.inputs.fire1=!!(4&t.i),this.inputs.fire2=!!(8&t.i),this.inputs.use=!!(16&t.i),this.inputs.reload=!!(32&t.i),this.inputs.melee=!!(64&t.i),this.inputs.zoom=!!(128&t.i),this.inputs.weapon=t.w)},t.prototype.setFromData=function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&(this.setLook(t.o),"object"===_typeof(t.p)&&_typeof(t.p.x)===_typeof(t.p.y)===_typeof(t.p.z)==="number"&&this.body.position.copy(t.p),"object"===_typeof(t.v)&&_typeof(t.v.x)===_typeof(t.v.y)===_typeof(t.v.z)==="number"&&this.body.velocity.copy(t.v),null!==t.g&&(this.isGrounded=t.g),null!==t.c&&(this.isCrounched=t.c))},t.prototype.getData=function(){return{o:this.orientation,p:{x:this.body.position.x,y:this.body.position.y,z:this.body.position.z},v:{x:this.body.velocity.x,y:this.body.velocity.y,z:this.body.velocity.z},g:this.isGrounded,c:this.isCrounched}},t.prototype.updateAll=function(){var t=this.inputs||{};this.setLook(t.orientation),this.updateGround(),this.updateMove(t.movement,t.jump),this.updateCrounch(t.crounch),this.updatePlatform(),this.setWeapon(t.weapon)},t.prototype.setLook=function(t){if(t){var o=2*Math.PI,e=.5*Math.PI;t.x%=o,t.y%=o,t.y>e?t.y=e:t.y<-e&&(t.y=-e),this.orientation=t}},t.prototype.addRotation=function(t){this.orientation.x+=t,this.orientation.x%=2*Math.PI},t.prototype.updateMove=function(o,e){o=o||{x:0,y:0};var i=o.x*o.x+o.y*o.y;if(i>1){var s=Math.sqrt(i);o.x/=s,o.y/=s}var r=this.orientation.x,n=this.isCrounched?t.ATTRIBUTES.crounchedSpeed:t.ATTRIBUTES.moveSpeed,a={y:this.body.velocity.y,x:(o.x*Math.cos(r)-o.y*Math.sin(r))*n,z:(-o.x*Math.sin(r)-o.y*Math.cos(r))*n};e&&(this.jumpTimer=t.ATTRIBUTES.jumpTimer),this.jumpTimer>0&&--this.jumpTimer,this.isGrounded?this.jumpTimer>0&&(this.jumpTimer=0,a.y=t.ATTRIBUTES.jumpForce):(a.x+=this.body.velocity.x,a.z+=this.body.velocity.z,a.x*=.5,a.z*=.5),this.body.velocity=a},t.prototype.updateGround=function(){this.isGrounded=!1;for(var o=0;o<this.dimensions.vertices.length;++o){var e=this.body.vadd(this.dimensions.vertices[o]);e.y-=2*this.body.shapes[0].halfExtents.y;var i=t.checkCollision(this.body.world,e,-.1);if(i.hasHit){var r=i.hitNormalWorld.getAngle(s.Vec3.UNIT_Y);if(r<t.ATTRIBUTES.steepSlope){if(this.isGrounded=!0,i.body.type===s.Body.KINEMATIC){var n=!1;platform?platform.body!==i.body&&(n=!0):n=!0,n&&(this.platform={body:i.body},this.updatePlatform())}else this.platform=null;return}}}this.platform=null},t.prototype.updatePlatformPosition=function(){var t=this.platform;if(t){var o=t.pointToWorldFrame(t.localPos),e=o.vsub(t.globalPos);this.body.position=this.body.position.vadd(e);var i=t.body.quaternion.mult(t.localRot),s=i.mult(t.globalRot.inverse()),r={};s.toEuler(r),this.addRotation(r.y)}},t.prototype.updatePlatform=function(){this.platform&&(this.platform.globalPos=this.body.position.clone(),this.platform.localPos=this.platform.body.pointToLocalFrame(this.platform.globalPos),this.platform.globalRot=this.body.quaternion.clone(),this.platform.localRot=this.platform.body.quaternion.inverse().mult(this.platform.globalRot))},t.prototype.updateCrounch=function(o){var e=!0;if(o)e=!1,this.isCrounched=!0;else if(this.isCrounched)for(var i=0;i<this.dimensions.vertices.length&&e;++i){var s=this.body.vadd(this.dimensions.vertices[i]);s.y+=this.dimensions.head_h;var r=t.checkCollision(this.body.world,s,.1);r.hasHit&&(e=!1)}var n,a=this.body.shapes[0],h=this.body.shapeOffsets[0],d=t.ATTRIBUTES.crounchIncrement;e?2*a.halfExtents.y<this.dimensions.body_h&&(a.halfExtents.y+=2*d,h.y-=d,2*a.halfExtents.y>=this.dimensions.body_h&&(n=.5*this.dimensions.body_height,a.halfExtents.y=n,h.y=-n,this.isCrounched=!1)):2*a.halfExtents.y>this.dimensions.body_c&&(a.halfExtents.y-=2*d,h.y+=d,2*a.halfExtents.y<this.dimensions.body_c&&(n=.5*this.dimensions.body_c,a.halfExtents.y=n,h.y=-n))},t.prototype.setWeapon=function(t){if(0!==this.weapons.length||null!==t){var o=this.currentWeapon;if(t>-1&&t<this.weapons.length)null!==this.weapons[t]&&(o=t);else for(var e=-1==t?-1:1,i=0,s=!1;i<this.weapons.length||s;++i)o+=e,o>=this.weapons.length?o=0:0>o&&(o=this.weapons.length-1),null!==this.weapons[o]&&(s=!0);this.currentWeapon=o}},t.prototype.getDamage=function(o){if(this.armor>0){var e=o*t.ATTRIBUTES.armorProtection;o-=e,this.armor-=e,this.armor<0&&(o-=this.armor,this.armor=0)}this.health-=o,this.health<=0&&(this.isDead=!0)},t.prototype.getHealth=function(t){this.health+=t,this.health>this.maxHealth&&(this.health=this.maxHealth)},t.prototype.getArmor=function(t){this.armor+=t,this.armor>this.maxArmor&&(this.armor=this.maxArmor)},t.prototype.killed=function(t){t()};var r=.8,n=1.8,a=1,h=.6,d=.4,l=r,c=n-d,p=a-d;t.DIMENSIONS={head_w:h,head_h:d,body_w:l,body_h:c,body_c:p,vertices:[{x:0,z:0},{x:l,z:l},{x:l,z:-l},{x:-l,z:l},{x:-l,z:-l}]},t.checkCollision=function(t,o){var e=arguments.length<=2||void 0===arguments[2]?.1:arguments[2],i=new s.Vec3(o.x,o.y,o.z),r=i.vadd({y:e}),n=new s.Ray(i,r);return n.intersectWorld(t,{mode:Ray.CLOSEST,skipBackfaces:!0,collisionFilterGroup:1,collisionFilterMask:1}),n.result},t.ATTRIBUTES={defaultHealth:100,maxHealth:100,defaultArmor:0,maxArmor:100,armorProtection:2/3,moveSpeed:20,crounchedSpeed:10,jumpForce:30,jumpTimer:10,crounchIncrement:.05,steepSlope:50},t.FILTERS={none:{group:7,mask:7},alpha:{group:11,mask:11},beta:{group:19,mask:19}},i.Player=o,o.prototype.constructor=o,o.prototype.createCharacter=function(o,e){this.character=new t(this,o,e,{team:this.team})},i.World=e,e.prototype.constructor=e,e.prototype.update=function(){var t;for(t=0;t<this.characters.length;++t)this.characters[t].updateAll();for(world.step(this.step),t=0;t<this.characters.length;++t)this.characters[t].updatePlatformPosition()},e.prototype.addCharacter=function(t){this.characters.addElement(t),t.world=this,this.cannonWorld.addBody(t.body),this.worldRender&&t.characterModel&&this.worldRender.addCharacterModel(t.characterModel)},e.prototype.removeCharacter=function(t){var o=this.characters.removeElement(t);o>-1&&(t.world=null,this.cannonWorld.removeBody(t.body),this.worldRender&&t.characterModel&&this.worldRender.removeCharacter(t.characterModel))},e.FILTER={group:7,mask:7}}();
//# sourceMappingURL=herstal.shared.min.js.map
