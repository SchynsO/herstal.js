"use strict";!function(a){function b(a,c,e,g){g=g||{};var h=b.DIMENSIONS.head.width,i=b.DIMENSIONS.head.height,j=b.DIMENSIONS.body.width,k=b.DIMENSIONS.body.height;c=c||{x:0,y:0,z:0},c.y+=k,this.orientation=e||{x:0,y:0},this.isGounded=!1,this.isCrounched=!1,this.jumpTimer=0,this.platform=null;var l={x:0,z:0,y:.5*i},m={x:0,z:0,y:-.5*k},n=new d.Box({x:h,y:i,z:h}),o=new d.Box({x:j,y:k,z:j});this.team="number"==typeof g.team?g.team:b.TEAM.none;var p=b.FILTER[team];p||(p={group:7,mask:7}),this.body=new d.Body({position:c,mass:10,material:b.MATERIAL,fixedRotation:!0,collisionFilterGroup:p.group,collisionFilterMask:p.mask}),this.body.addShape(o,m),this.body.addShape(n,l),this.body.character=this,n.isHead=!0,f.addBody(this.body)}function c(a,b){this.id=c.currentId++}var d,e;if("undefined"==typeof e&&(e={}),"undefined"==typeof d)throw new Error("Herstal require CANNON.js to work");var f=new d.World;f.gravity.set(0,-100,0),f.defaultContactMaterial.friction=.1,b.prototype.constructor=b;var g=.8,h=1.8,i=1,j=.6,k=.4,l=g,m=h-k,n=i-k;b.DIMENSIONS={head:{width:j,height:k},body:{width:l,height:m,crounched:n},vertices:[{x:0,z:0},{x:l,z:l},{x:l,z:-l},{x:-l,z:l},{x:-l,z:-l}],checkCollision:function(b,c){var e=arguments[2]===a?.1:arguments[2],f=new d.Vec3(c.x,c.y,c.z),g=f.vadd({y:e}),h=new d.Ray(f,g);return h.intersectWorld(b,{mode:Ray.CLOSEST,skipBackfaces:!0,collisionFilterGroup:1,collisionFilterMask:1}),h.result}};var o=20,p=30,q=.05;b.ATTRIBUTES={moveSpeed:o,crounchedSpeed:.5*o,jumpForce:p,jumpTimer:10,crounchIncrement:q,steepSlope:50},b.MATERIAL=new d.Material("character"),f.addContactMaterial(new d.ContactMaterial(b.MATERIAL,f.defaultMaterial,{friction:0,restitution:0,contactEquationStiffness:1e8,contactEquationRelaxation:3})),b.TEAM={id:{none:0,alpha:1,beta:2},filters:[{group:7,mask:7},{group:11,mask:11},{group:19,mask:19}]},b.prototype.updateLook=function(a){if(a){var b=2*Math.PI,c=.5*Math.PI;a.x%=b,a.y%=b,a.y>c?a.y=c:a.y<-c&&(a.y=-c),this.orientation=a}},b.prototype.addRotation=function(a){this.orientation.x+=a,this.orientation.x%=2*Math.PI},b.prototype.updateMove=function(a,c){a=a||{x:0,y:0};var d=a.x*a.x+a.y*a.y;if(d>1){var e=Math.sqrt(d);a.x/=e,a.y/=e}var f=this.orientation.x,g=this.isCrounched?b.ATTRIBUTES.crounchedSpeed:b.ATTRIBUTES.moveSpeed,h={y:this.body.velocity.y,x:(a.x*Math.cos(f)-a.y*Math.sin(f))*g,z:(-a.x*Math.sin(f)-a.y*Math.cos(f))*g};c&&(this.jumpTimer=b.ATTRIBUTES.jumpTimer),this.jumpTimer>0&&--this.jumpTimer,this.isGrounded?this.jumpTimer>0&&(this.jumpTimer=0,h.y=b.ATTRIBUTES.jumpForce):(h.x+=this.body.velocity.x,h.z+=this.body.velocity.z,h.x*=.5,h.z*=.5),this.body.velocity=h},b.prototype.updateGround=function(){this.isGrounded=!1;for(var a=0;a<b.DIMENSIONS.vertices.length;++a){var c=this.body.vadd(b.DIMENSIONS.vertices[a]);c.y-=2*this.body.shapes[0].halfExtents.y;var e=b.DIMENSIONS.checkCollision(this.body.world,c,-.1);if(e.hasHit){var f=e.hitNormalWorld.getAngle(d.Vec3.UNIT_Y);if(f<b.ATTRIBUTES.steepSlope){if(this.isGrounded=!0,e.body.type===d.Body.KINEMATIC){var g=!1;platform?platform.body!==e.body&&(g=!0):g=!0,g&&(this.platform={body:e.body},this.updatePlatform())}else this.platform=null;return}}}this.platform=null},b.prototype.updatePosition=function(){var a=this.platform;if(a){var b=a.pointToWorldFrame(a.localPos),c=b.vsub(a.globalPos);this.body.position=this.body.position.vadd(c);var d=a.body.quaternion.mult(a.localRot),e=d.mult(a.globalRot.inverse()),f={};e.toEuler(f),this.addRotation(f.y)}},b.prototype.updatePlatform=function(){var a=this.platform;a&&(a.globalPos=this.body.position.clone(),a.localPos=a.body.pointToLocalFrame(a.globalPos),a.globalRot=this.body.quaternion.clone(),a.localRot=a.body.quaternion.inverse().mult(a.globalRot))},b.prototype.updateCrounch=function(a){var c=b.DIMENSIONS,d=!0;if(a)d=!1,this.isCrounched=!0;else if(this.isCrounched)for(var e=0;e<c.vertices.length&&d;++e){var f=this.body.vadd(c.vertices[e]);f.y+=c.head.height;var g=c.checkCollision(this.body.world,f,.1);g.hasHit&&(d=!1)}var h,i=this.body.shapes[0],j=this.body.shapeOffsets[0],k=character.ATTRIBUTES.crounchIncrement;d?2*i.halfExtents.y<c.body.height&&(i.halfExtents.y+=2*k,j.y-=k,2*i.halfExtents.y>c.body.height&&(h=.5*c.body.height,i.halfExtents.y=h,j.y=-h)):2*i.halfExtents.y>c.body.crounched&&(i.halfExtents.y-=2*k,j.y+=k,2*i.halfExtents.y<c.body.crounched&&(h=.5*c.body.crounched,i.halfExtents.y=h,j.y=-h))},c.prototype.constructor=c,c.currentId=0,d.Vec3.prototype.getAngle=function(a){var b=this.clone(),c=a?new d.Vec3(a.x,a.y,a.z):d.Vec3.UNIT_Y;return b.normalize(),c.normalize(),Math.acos(b.dot(c))},e.exports={WORLD:f,Character:b,Player:c}}();