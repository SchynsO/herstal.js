"use strict";!function(a){function b(a,c,d,e){e=e||{};var f=b.DIMENSIONS.head.width,i=b.DIMENSIONS.head.height,j=b.DIMENSIONS.body.width,k=b.DIMENSIONS.body.height;c=c||{x:0,y:0,z:0},c.y+=k,this.orientation=d||{x:0,y:0},this.isGounded=!1,this.isCrounched=!1,this.jumpTimer=0,this.platform=null;var l={x:0,z:0,y:.5*i},m={x:0,z:0,y:-.5*k},n=new g.Box({x:f,y:i,z:f}),o=new g.Box({x:j,y:k,z:j}),p=e.team||"none",q=b.FILTERS[p];q||(q={group:7,mask:7}),this.body=new g.Body({position:c,mass:10,material:b.MATERIAL,fixedRotation:!0,collisionFilterGroup:q.group,collisionFilterMask:q.mask}),this.body.addShape(o,m),this.body.addShape(n,l),this.body.character=this,n.isHead=!0,h.addBody(this.body)}function c(a,b,c){this.id=a,this.name=b,this.colors=c,this.team="none"}var d,e,f=f||{};e||(e={}),d||(d=Object.defineProperties({},{exports:{get:function(){return e.HERSTAL},set:function(a){e.HERSTAL=a},enumerable:!0,configurable:!0}}));var g=require("../../lib/cannon.min.js");if(!g)throw new Error("Herstal.shared needs CANNON.js to work");var h=new g.World;h.gravity.set(0,-100,0),h.defaultContactMaterial.friction=.1,b.prototype.constructor=b;var i=.8,j=1.8,k=1,l=.6,m=.4,n=i,o=j-m,p=k-m;b.DIMENSIONS={head:{width:l,height:m},body:{width:n,height:o,crounched:p},vertices:[{x:0,z:0},{x:n,z:n},{x:n,z:-n},{x:-n,z:n},{x:-n,z:-n}],checkCollision:function(b,c){var d=arguments[2]===a?.1:arguments[2],e=new g.Vec3(c.x,c.y,c.z),f=e.vadd({y:d}),h=new g.Ray(e,f);return h.intersectWorld(b,{mode:Ray.CLOSEST,skipBackfaces:!0,collisionFilterGroup:1,collisionFilterMask:1}),h.result}};var q=20,r=30,s=.05;b.ATTRIBUTES={moveSpeed:q,crounchedSpeed:.5*q,jumpForce:r,jumpTimer:10,crounchIncrement:s,steepSlope:50},b.MATERIAL=new g.Material("character"),h.addContactMaterial(new g.ContactMaterial(b.MATERIAL,h.defaultMaterial,{friction:0,restitution:0,contactEquationStiffness:1e8,contactEquationRelaxation:3})),b.FILTERS={none:{group:7,mask:7},alpha:{group:11,mask:11},beta:{group:19,mask:19}},b.prototype.updateLook=function(a){if(a){var b=2*Math.PI,c=.5*Math.PI;a.x%=b,a.y%=b,a.y>c?a.y=c:a.y<-c&&(a.y=-c),this.orientation=a}},b.prototype.addRotation=function(a){this.orientation.x+=a,this.orientation.x%=2*Math.PI},b.prototype.updateMove=function(a,c){a=a||{x:0,y:0};var d=a.x*a.x+a.y*a.y;if(d>1){var e=Math.sqrt(d);a.x/=e,a.y/=e}var f=this.orientation.x,g=this.isCrounched?b.ATTRIBUTES.crounchedSpeed:b.ATTRIBUTES.moveSpeed,h={y:this.body.velocity.y,x:(a.x*Math.cos(f)-a.y*Math.sin(f))*g,z:(-a.x*Math.sin(f)-a.y*Math.cos(f))*g};c&&(this.jumpTimer=b.ATTRIBUTES.jumpTimer),this.jumpTimer>0&&--this.jumpTimer,this.isGrounded?this.jumpTimer>0&&(this.jumpTimer=0,h.y=b.ATTRIBUTES.jumpForce):(h.x+=this.body.velocity.x,h.z+=this.body.velocity.z,h.x*=.5,h.z*=.5),this.body.velocity=h},b.prototype.updateGround=function(){this.isGrounded=!1;for(var a=0;a<b.DIMENSIONS.vertices.length;++a){var c=this.body.vadd(b.DIMENSIONS.vertices[a]);c.y-=2*this.body.shapes[0].halfExtents.y;var d=b.DIMENSIONS.checkCollision(this.body.world,c,-.1);if(d.hasHit){var e=d.hitNormalWorld.getAngle(g.Vec3.UNIT_Y);if(e<b.ATTRIBUTES.steepSlope){if(this.isGrounded=!0,d.body.type===g.Body.KINEMATIC){var f=!1;platform?platform.body!==d.body&&(f=!0):f=!0,f&&(this.platform={body:d.body},this.updatePlatform())}else this.platform=null;return}}}this.platform=null},b.prototype.updatePosition=function(){var a=this.platform;if(a){var b=a.pointToWorldFrame(a.localPos),c=b.vsub(a.globalPos);this.body.position=this.body.position.vadd(c);var d=a.body.quaternion.mult(a.localRot),e=d.mult(a.globalRot.inverse()),f={};e.toEuler(f),this.addRotation(f.y)}},b.prototype.updatePlatform=function(){var a=this.platform;a&&(a.globalPos=this.body.position.clone(),a.localPos=a.body.pointToLocalFrame(a.globalPos),a.globalRot=this.body.quaternion.clone(),a.localRot=a.body.quaternion.inverse().mult(a.globalRot))},b.prototype.updateCrounch=function(a){var c=b.DIMENSIONS,d=!0;if(a)d=!1,this.isCrounched=!0;else if(this.isCrounched)for(var e=0;e<c.vertices.length&&d;++e){var f=this.body.vadd(c.vertices[e]);f.y+=c.head.height;var g=c.checkCollision(this.body.world,f,.1);g.hasHit&&(d=!1)}var h,i=this.body.shapes[0],j=this.body.shapeOffsets[0],k=character.ATTRIBUTES.crounchIncrement;d?2*i.halfExtents.y<c.body.height&&(i.halfExtents.y+=2*k,j.y-=k,2*i.halfExtents.y>c.body.height&&(h=.5*c.body.height,i.halfExtents.y=h,j.y=-h)):2*i.halfExtents.y>c.body.crounched&&(i.halfExtents.y-=2*k,j.y+=k,2*i.halfExtents.y<c.body.crounched&&(h=.5*c.body.crounched,i.halfExtents.y=h,j.y=-h))},c.prototype.constructor=c,c.prototype.createCharacter=function(a,c){this.character=new b(this,a,c,{team:this.team})},g.Vec3.prototype.getAngle=function(a){var b=this.clone(),c=a?new g.Vec3(a.x,a.y,a.z):g.Vec3.UNIT_Y;return b.normalize(),c.normalize(),Math.acos(b.dot(c))},d.exports={WORLD:h,Player:c,Character:b}}();